# -*- eval: (add-hook (quote org-babel-after-execute-hook) (function org-redisplay-inline-images)); -*-
#+STARTUP: inlineimages entitiespretty

These are benchmarks made while integrating NeoEMF and EMF Views.  All times are
in milliseconds, unless otherwise specified.  Sizes are in KB, as reported by
~ls--block-size=K~ for XMI files, and ~du~ for GraphDB folders.

* Versions and parameters
** EMF
Standard EMF available in Eclipse.

EMF version: 2.13.0.v20170609-0928

Default loading and saving options (empty map) unless otherwise specified.

** SOM-NeoEMF
Basically NeoEMF 1.0.2 with a few patches.

https://github.com/SOM-Research/NeoEMF
Commit used: 9a876b402fa38983e4d1f95ccf2b0ca44068b5da

Unless otherwise specified, saving options are:
: BlueprintsNeo4jOptionsBuilder.newBuilder().weakCache().autocommit().asMap();

Loading options are:
: BlueprintsNeo4jOptionsBuilder.newBuilder().asMap();

(actual options will depend on how the resource was serialized)

For DirectWriteLongList, saving options are:
: BlueprintsNeo4jOptionsBuilder.newBuilder()
:   .weakCache().directWriteLongListSupport().autocommit().asMap();

For loading:
: BlueprintsNeo4jOptionsBuilder.newBuilder()
:   .softCache().directWriteLongListSupport().asMap();

** atlanmod-NeoEMF
1100 commits beyond 1.0.2, with large refactorings.

https://github.com/atlanmod/NeoEMF
Commit used: ed6f37e2ef0bf25e32b12659e8d09285c254cfe4

Unless otherwise specified, saving options are:
: BlueprintsNeo4jConfig.newConfig().autoSave().toMap();

Loading options are:
: BlueprintsNeo4jConfig.newConfig().toMap();

* Create trace models
Create trace models up to size 10^6, serialized as XMI, or in a database.

Legend:
- Size :: number of Log elements in the resource (10^n)
- Populate :: time to add all the elements to the provided resource
- Full :: time to create the resource, populate it, save it and eventually close
          it (for NeoEMF)
- XMI :: size of the XMI file on disk
- GraphDB :: size of the GraphDB folder on disk

** Using EMF

#+name: create-emf
| size | populate | full |    XMI |
|------+----------+------+--------|
|    1 |      229 |  339 |      2 |
|    2 |        1 |    5 |     12 |
|    3 |        7 |   28 |    118 |
|    4 |       36 |   98 |   1178 |
|    5 |      135 |  332 |  11778 |
|    6 |      524 | 1485 | 117774 |

** Using SOM-NeoEMF
*** Using DirectWriteLongListSupport
Using saving options:
: BlueprintsNeo4jOptionsBuilder.newBuilder()
:   .weakCache().directWriteLongListSupport().autocommit().asMap();

#+name: create-som-neoemf-long-list
| size | populate |    full | GraphDB (KB) |
|------+----------+---------+--------------|
|    1 |      376 |    2627 |          348 |
|    2 |      377 |     985 |          764 |
|    3 |      842 |    1730 |         5000 |
|    4 |     8941 |   10594 |        47828 |
|    5 |    97795 |   99768 |       473992 |
|    6 |  1122814 | 1123521 |      4755528 |

*** Using DirectWrite
Saving options:
: BlueprintsNeo4jOptionsBuilder.newBuilder()
:   .weakCache().autocommit().asMap();

#+name: create-som-neoemf
| size | populate |    full | GraphDB (KB) |
|------+----------+---------+--------------|
|    1 |      203 |    1827 |          336 |
|    2 |      251 |     832 |          588 |
|    3 |     1003 |    1703 |         3276 |
|    4 |    21434 |   22697 |        30312 |
|    5 |  2537824 | 2539457 |       346072 |
|    6 |        n |       n |            n |

** Using atlanmod-NeoEMF

#+name: create-atlanmod-neoemf
| size |    full | GraphDB (KB) |
|------+---------+--------------|
|    1 |    6677 |          648 |
|    2 |    1497 |          784 |
|    3 |    2415 |         2200 |
|    4 |   35925 |        16368 |
|    5 | 3190291 |       171304 |
|    6 |       n |            n |

** Aggregate results and graphs
*** Time for creating the trace model

#+name: agg-create
| size |  EMF | SOM-NeoEMF-LL | SOM-NeoEMF | AtlanMod-NeoEMF |
|------+------+---------------+------------+-----------------|
|    1 |  339 |          2627 |       1827 |            6677 |
|    2 |    5 |           985 |        832 |            1497 |
|    3 |   28 |          1730 |       1703 |            2415 |
|    4 |   98 |         10594 |      22697 |           35925 |
|    5 |  332 |         99768 |    2539457 |         3190291 |
|    6 | 1485 |       1123521 |          n |               n |
#+TBLFM: @2$2..@>$2=remote(create-emf, @@#$3)
#+TBLFM: @2$3..@>$3=remote(create-som-neoemf-long-list,@@#$3)
#+TBLFM: @2$4..@>$4=remote(create-som-neoemf,@@#$3)
#+TBLFM: @2$5..@>$5=remote(create-atlanmod-neoemf,@@#$2)

#+begin_src gnuplot :var data=agg-create :file bench-all-create-trace.png
set title 'Create trace model (time)'
set key left

set xlabel 'model size'
set logscale x
set ylabel 'time (ms)'
set logscale y

plot data u (10**$1):2 w lp title 'EMF', \
     data u (10**$1):4 w lp title 'SOM-NeoEMF', \
     data u (10**$1):3 w lp title 'SOM-NeoEMF-LL', \
     data u (10**$1):5 w lp title 'Atl-NeoEMF'
#+end_src

#+RESULTS:
[[file:bench-all-create-trace.png]]

*** Size of trace model on disk
#+name: agg-create-size
| size |    EMF | SOM-NeoEMF-LL | SOM-NeoEMF | AtlanMod-NeoEMF |
|------+--------+---------------+------------+-----------------|
|    1 |      2 |           348 |        336 |             648 |
|    2 |     12 |           764 |        588 |             784 |
|    3 |    118 |          5000 |       3276 |            2200 |
|    4 |   1178 |         47828 |      30312 |           16368 |
|    5 |  11778 |        473992 |     346072 |          171304 |
|    6 | 117774 |       4755528 |          n |               n |
#+TBLFM: @2$2..@>$2=remote(create-emf, @@#$4)
#+TBLFM: @2$3..@>$3=remote(create-som-neoemf-long-list,@@#$4)
#+TBLFM: @2$4..@>$4=remote(create-som-neoemf,@@#$4)
#+TBLFM: @2$5..@>$5=remote(create-atlanmod-neoemf,@@#$3)

#+begin_src gnuplot :var data=agg-create-size :file bench-all-create-trace-size.png
set title 'Create trace model (size)'
set key left

set xlabel 'model size (10^n)'
set logscale x
set ylabel 'size (KB)'
set logscale y

plot data u (10**$1):2 w lp title 'EMF (XMI)', \
     data u (10**$1):4 w lp title 'SOM-NeoEMF (GraphDB)', \
     data u (10**$1):3 w lp title 'SOM-NeoEMF-LL (GraphDB)', \
     data u (10**$1):5 w lp title 'Atl-NeoEMF (GraphDB)'
#+end_src

#+RESULTS:
[[file:bench-all-create-trace-size.png]]

* Create weaving models
Create a weaving model for a view aggregating the four models.  This
construction by-passes the ECL for the javaClass rule, since the naive ECL
algorithm is O(n*m).

We serialize the weaving model as XMI and as a database, for later comparisons
when running transformations and queries on views.

Legend:
- Size :: ibidem
- javaClass rule :: time to match the rule between the Trace and Java metamodels
- ECL rules :: time to match the remaining 2 rules with ECL (small models)
- Save :: time to serialize the WeavingModel resource
- Full :: time to do load the Trace model, match and save
- XMI :: size of the XMI weaving model on disk
- GraphDB :: size of the GraphDB folder on disk

** Using EMF trace
*** XMI weaving model
Average numbers after 5 warmups / 5 iterations.

#+name: xmi-weaving-emf
| Size | javaClass | ECL |   save |   full |    XMI |
|------+-----------+-----+--------+--------+--------|
|    1 |        15 |  61 |      2 |     80 |     11 |
|    2 |        11 |  54 |      5 |     73 |     36 |
|    3 |        14 |  36 |      9 |     67 |    285 |
|    4 |        52 |  39 |    102 |    216 |   2799 |
|    5 |      1868 |  25 |   3821 |   5877 |  28112 |
|    6 |    160090 |  21 | 345742 | 507584 | 282994 |

*** NeoEMF weaving model

#+name: neo-weaving-emf
| Size | load | javaClass | ECL |  save |   full | GraphDB |
|------+------+-----------+-----+-------+--------+---------|
|    1 |    4 |       158 | 324 |  1390 |   1886 |     484 |
|    2 |   14 |        72 |  82 |   737 |    908 |     976 |
|    3 |   52 |       195 |  81 |  1136 |   1466 |    6068 |
|    4 |  138 |      1484 |  72 |  4294 |   5991 |   57520 |
|    5 |  256 |    217313 | 351 | 28999 | 246919 |  638876 |
|    6 |    n |         n |   n |     n |      n |       n |

** Using SOM-NeoEMF trace
*** XMI weaving model

#+name: xmi-weaving-som-neoemf
| Size | load | javaClass | ECL | save |    full |   XMI |
|------+------+-----------+-----+------+---------+-------|
|    1 | 1277 |      1119 |  66 |    2 |    2543 |    11 |
|    2 |   79 |       234 |  71 |    2 |     471 |    37 |
|    3 |   47 |      1065 |  33 |    6 |    1245 |   297 |
|    4 |   25 |     20680 |  40 |   74 |   20901 |  2908 |
|    5 |  205 |   2123328 |  38 | 1905 | 2125560 | 29099 |
|    6 |    n |         n |   n |    n |       n |     n |

*** NeoEMF weaving model
**** DirectWrite

#+name: neo-weaving-som-neoemf
| Size | load | javaClass | ECL |  save |    full | GraphDB |
|------+------+-----------+-----+-------+---------+---------|
|    1 |   62 |        52 |  46 |   569 |     810 |     932 |
|    2 |   25 |        61 |  61 |   675 |     900 |   12412 |
|    3 |   33 |       314 |  30 |   887 |    1347 |   16684 |
|    4 |   47 |     26422 |  47 |  2386 |   28988 |   67780 |
|    5 |   31 |   3049003 | 113 | 26780 | 3076031 |  649116 |
|    6 |    n |         n |   n |     n |       n |       n |

**** DirectWriteLongList

#+name: neo-weaving-som-neoemf-long-list
| Size | load | javaClass | ECL | save |    full |  GraphDB |
|------+------+-----------+-----+------+---------+----------|
|    1 | 1139 |       522 | 471 |  344 |    3077 |      704 |
|    2 |  337 |       428 | 145 |  324 |    1661 |     1828 |
|    3 |  462 |      1537 | 118 |  956 |    3485 |    13284 |
|    4 |  252 |     14962 |  75 | 1934 |   17587 |   130736 |
|    5 |  333 |    105165 |  64 |  583 |  106681 |  1316776 |
|    6 |  190 |   1340860 |  68 | 1551 | 1353340 | 13263500 |

** Using atlanmod-NeoEMF trace
*** XMI weaving model

#+name: xmi-weaving-atl-neoemf
| size | load | populate | save |   full | GraphDB |
|------+------+----------+------+--------+---------|
|    1 | 1149 |      166 |   18 |   4658 |     484 |
|    2 |  151 |      123 |   10 |    481 |     967 |
|    3 |  124 |      506 |   41 |    866 |    6068 |
|    4 |   96 |    11181 |  134 |  11593 |   57520 |
|    5 |  113 |   945415 | 2422 | 948163 |  638884 |
|    6 |    n |        n |    n |      n |       n |

*** NeoEMF weaving model

#+name: neo-weaving-atl-neoemf
| size | load | populate |    save |     full | GraphDB |
|------+------+----------+---------+----------+---------|
|    1 |  101 |      149 |    1082 |     1632 |     536 |
|    2 |   95 |      228 |    1198 |     1722 |     744 |
|    3 |  148 |     2106 |    2277 |     4718 |    2920 |
|    4 |   98 |   102354 |   43393 |   146230 |   24660 |
|    5 |  179 | 10056899 | 3853064 | 13912304 |  293236 |
|    6 |    n |        n |       n |        n |       n |

** Aggregate results and graphs
*** Time to create weaving models
#+name: agg-weaving
| size | EMF (XMI) | EMF (DB) | SOM-NeoEMF (XMI) | SOM-NeoEMF (DB) | SOM-NeoEMF-LL (DB) | Atl-NeoEMF (XMI) | Atl-NeoEMF (DB) |
|------+-----------+----------+------------------+-----------------+--------------------+------------------+-----------------|
|    1 |        80 |     1886 |             2543 |             810 |               3077 |             4658 |            1632 |
|    2 |        73 |      908 |              471 |             900 |               1661 |              481 |            1722 |
|    3 |        67 |     1466 |             1245 |            1347 |               3485 |              866 |            4718 |
|    4 |       216 |     5991 |            20901 |           28988 |              17587 |            11593 |          146230 |
|    5 |      5877 |   246919 |          2125560 |         3076031 |             106681 |           948163 |        13912304 |
|    6 |    507584 |        n |                n |               n |            1353340 |                n |               n |
#+TBLFM: @2$2..@>$2=remote(xmi-weaving-emf, @@#$5)
#+TBLFM: @2$3..@>$3=remote(neo-weaving-emf, @@#$6)
#+TBLFM: @2$4..@>$4=remote(xmi-weaving-som-neoemf,@@#$6)
#+TBLFM: @2$5..@>$5=remote(neo-weaving-som-neoemf,@@#$6)
#+TBLFM: @2$6..@>$6=remote(neo-weaving-som-neoemf-long-list,@@#$6)
#+TBLFM: @2$7..@>$7=remote(xmi-weaving-atl-neoemf,@@#$5)
#+TBLFM: @2$8..@>$8=remote(neo-weaving-atl-neoemf,@@#$5)

#+begin_src gnuplot :var data=agg-weaving :file bench-all-create-weaving-time.png
set title 'Create weaving models (time)'
set key left font ",9"

set xlabel 'model size (10^n)'
set logscale x
set ylabel 'time (ms)'
set logscale y

plot data u (10**$1):2 w lp title 'EMF (XMI)', \
     data u (10**$1):5 w lp title 'SOM-NeoEMF (DB)', \
     data u (10**$1):6 w lp title 'SOM-NeoEMF-LL (DB)', \
     data u (10**$1):8 w lp title 'Atl-NeoEMF (DB)'
#+end_src

#+RESULTS:
[[file:bench-all-create-weaving-time.png]]

*** Size of weaving models on disk
#+name: agg-weaving-size
| size | EMF (XMI) | EMF (DB) | SOM-NeoEMF (XMI) | SOM-NeoEMF (DB) | SOM-NeoEMF-LL (DB) | Atl-NeoEMF (XMI) | Atl-NeoEMF (DB) |
|------+-----------+----------+------------------+-----------------+--------------------+------------------+-----------------|
|    1 |        11 |      484 |               11 |             932 |                704 |              484 |             536 |
|    2 |        36 |      976 |               37 |           12412 |               1828 |              967 |             744 |
|    3 |       285 |     6068 |              297 |           16684 |              13284 |             6068 |            2920 |
|    4 |      2799 |    57520 |             2908 |           67780 |             130736 |            57520 |           24660 |
|    5 |     28112 |   638876 |            29099 |          649116 |            1316776 |           638884 |          293236 |
|    6 |    282994 |        n |                n |               n |           13263500 |                n |               n |
#+TBLFM: @2$2..@>$2=remote(xmi-weaving-emf, @@#$6)
#+TBLFM: @2$3..@>$3=remote(neo-weaving-emf, @@#$7)
#+TBLFM: @2$4..@>$4=remote(xmi-weaving-som-neoemf,@@#$7)
#+TBLFM: @2$5..@>$5=remote(neo-weaving-som-neoemf,@@#$7)
#+TBLFM: @2$6..@>$6=remote(neo-weaving-som-neoemf-long-list,@@#$7)
#+TBLFM: @2$7..@>$7=remote(xmi-weaving-atl-neoemf,@@#$6)
#+TBLFM: @2$8..@>$8=remote(neo-weaving-atl-neoemf,@@#$6)

#+begin_src gnuplot :var data=agg-weaving-size :file bench-all-create-weaving-size.png
set title 'Create weaving models (size)'
set key left font ",9"

set xlabel 'model size (10^n)'
set logscale x
set ylabel 'size (KB)'
set logscale y

plot data u (10**$1):2 w lp title 'EMF (XMI)', \
     data u (10**$1):4 w lp title 'SOM-NeoEMF (XMI)', \
     data u (10**$1):7 w lp title 'Atl-NeoEMF (XMI)', \
     data u (10**$1):3 w lp title 'EMF (DB)', \
     data u (10**$1):5 w lp title 'SOM-NeoEMF (DB)', \
     data u (10**$1):6 w lp title 'SOM-NeoEMF-LL (DB)', \
     data u (10**$1):8 w lp title 'Atl-NeoEMF (DB)'
#+end_src

#+RESULTS:
[[file:bench-all-create-weaving-size.png]]

* Run ATL transformation
Execute an ATL transformation on the view that touches all models (including all
elements of the trace model).

Legend:
- Size :: ibidem
- Load :: time to load the viewpoint and view resources
- Transform :: time to run the transformation (execute ~ExecEnv.run~)
- Full :: time to load the resources, init ATL, and execute the transformation

** Using EMF trace
Average numbers after 5 warmups / 5 iterations

*** XMI weaving model

#+name: xmi-atl-emf
| Size | Load | Transform |   Full |
|------+------+-----------+--------|
|    1 |  220 |       650 |    885 |
|    2 |  152 |       655 |    821 |
|    3 |  161 |      1078 |   1250 |
|    4 |  494 |      6135 |   6643 |
|    5 | 3768 |    130397 | 134223 |
|    6 |    n |         n |      n |

** Using SOM-NeoEMF trace
*** XMI weaving model

#+name: xmi-atl-som-neoemf
| size | load | transform |    full |
|------+------+-----------+---------|
|    1 |  896 |       917 |    2072 |
|    2 |  329 |       617 |    1143 |
|    3 |  533 |      1820 |    2890 |
|    4 | 1346 |     58789 |   60334 |
|    5 | 6786 |   5616109 | 5623177 |
|    6 |    n |         n |       n |

*** NeoEMF weaving model

#+name: neo-atl-som-neoemf
| size |    load | transform |    full |
|------+---------+-----------+---------|
|    1 |     228 |       698 |    1148 |
|    2 |     238 |       963 |    1458 |
|    3 |     575 |      1468 |    2230 |
|    4 |   23394 |     65338 |   88937 |
|    5 | 2157699 |   4944843 | 7102815 |
|    6 |       n |         n |       n |

** Using atlanmod-NeoEMF trace
*** XMI weaving model

#+name: xmi-atl-atl-neoemf
| Size | load | transform |    full |
|------+------+-----------+---------|
|    1 | 4294 |      1664 |    6727 |
|    2 |  472 |       795 |    1621 |
|    3 |  388 |      1998 |    2711 |
|    4 |  448 |     36373 |   37096 |
|    5 | 1069 |   3334126 | 3335569 |
|    6 |    n |         n |       n |

*** NeoEMF weaving model

#+name: neo-atl-atl-neoemf
| Size | load | transform |    full |
|------+------+-----------+---------|
|    1 |  522 |       515 |    1296 |
|    2 |  515 |       468 |    1252 |
|    3 |  291 |      1551 |    2093 |
|    4 |  298 |     45316 |   45879 |
|    5 |  323 |   4069452 | 4070129 |
|    6 |    n |         n |       n |

** Aggregate results and graphs

#+name: agg-atl
| size | EMF (XMI) | EMF (DB) | SOM-NeoEMF (XMI) | SOM-NeoEMF (DB) | Atl-NeoEMF (XMI) | Atl-NeoEMF (DB) |
|------+-----------+----------+------------------+-----------------+------------------+-----------------|
|    1 |       885 | n        |             2072 |            1148 |             6727 |            1296 |
|    2 |       821 | n        |             1143 |            1458 |             1621 |            1252 |
|    3 |      1250 | n        |             2890 |            2230 |             2711 |            2093 |
|    4 |      6643 | n        |            60334 |           88937 |            37096 |           45879 |
|    5 |    134223 | n        |          5623177 |         7102815 |          3335569 |         4070129 |
|    6 |         n | n        |                n |               n |                n |               n |
#+TBLFM: @2$2..@>$2=remote(xmi-atl-emf, @@#$4)
#+TBLFM: @2$3..@>$3=remote(neo-atl-emf, @@#$4)
#+TBLFM: @2$4..@>$4=remote(xmi-atl-som-neoemf,@@#$4)
#+TBLFM: @2$5..@>$5=remote(neo-atl-som-neoemf,@@#$4)
#+TBLFM: @2$6..@>$6=remote(xmi-atl-atl-neoemf,@@#$4)
#+TBLFM: @2$7..@>$7=remote(neo-atl-atl-neoemf,@@#$4)

#+begin_src gnuplot :var data=agg-atl :file bench-all-run-atl.png
set title 'Run ATL transformation'
set key left font ",9"

set xlabel 'model size (10^n)'
set logscale x
set ylabel 'time (ms)'
set logscale y

plot data u (10**$1):2 w lp title 'EMF (XMI)', \
     data u (10**$1):5 w lp title 'SOM-NeoEMF (DB)', \
     data u (10**$1):7 w lp title 'Atl-NeoEMF (DB)'
#+end_src

#+RESULTS:
[[file:bench-all-run-atl.png]]

* Load view/model
Do a ~resource.load~ on each view.  Mainly to show that there are no overheads
to loading a view, even when backed with a DB resource.

Legend:
- Size :: ibidem
- Load :: time to lead the view resource
- First :: time get the first element in the view
- All :: time to enumerate all contents in the view
- All0 :: time to go through the contents of the Trace model only

** Using EMF trace
*** No weaving model
#+name: xmi-load
| size | load | first | all |
|------+------+-------+-----|
|    1 |    8 |     0 |   1 |
|    2 |    3 |     0 |   1 |
|    3 |   26 |     0 |   1 |
|    4 |  103 |     0 |   7 |
|    5 |  614 |     0 |  34 |
|    6 | 2154 |     0 | 187 |

*** View with XMI weaving model
#+name: xmi-view-load
| size |  load | first |  all | all0 |
|------+-------+-------+------+------|
|    1 |   788 |     1 | 1468 |    2 |
|    2 |   257 |     0 |  641 |    0 |
|    3 |   245 |     0 |  469 |    3 |
|    4 |   389 |     0 |  623 |    6 |
|    5 |   921 |     0 |  948 |   58 |
|    6 | 12214 |     0 | 1946 |  836 |

** Using SOM-NeoEMF trace
*** No weaving model
**** DirectWrite
#+name: neoemf-load-direct-write
| size | load | first |     all |
|------+------+-------+---------|
|    1 |  735 |   169 |      26 |
|    2 |   54 |     9 |     209 |
|    3 |   42 |    11 |     705 |
|    4 |   94 |    35 |   14094 |
|    5 |   32 |   150 | 1359528 |
|    6 |    n |     n |       n |

**** DirectWriteLongList
#+name: neoemf-load-long-list
| size | load | first |   all |
|------+------+-------+-------|
|    1 |  657 |  1237 |    44 |
|    2 |   64 |    19 |   218 |
|    3 |   51 |    13 |   642 |
|    4 |   38 |    39 |  1035 |
|    5 |   35 |   185 |  6645 |
|    6 |   43 |  1046 | 76221 |

*** View with NeoEMF weaving model
#+name: neoemf-view-load-long-list
| size | load | first |   all |  all0 |
|------+------+-------+-------+-------|
|    1 | 2265 |     1 |  5049 |    41 |
|    2 |  870 |     0 |  3029 |    74 |
|    3 |  750 |     0 |  2222 |   193 |
|    4 |  811 |     0 |  2833 |   554 |
|    5 | 2482 |     0 |  6795 |  2033 |
|    6 | 3006 |     0 | 82323 | 32851 |

** Aggregate results and graphs
#+name: agg-load
| size | XMI | XMI View |  NeoEMF | NeoEMF (LL) | NeoEMF View (LL) |
|------+-----+----------+---------+-------------+------------------|
|    1 |   1 |     1468 |      26 |          44 |             5049 |
|    2 |   1 |      641 |     209 |         218 |             3029 |
|    3 |   1 |      469 |     705 |         642 |             2222 |
|    4 |   7 |      623 |   14094 |        1035 |             2833 |
|    5 |  34 |      948 | 1359528 |        6645 |             6795 |
|    6 | 187 |     1946 |       n |       76221 |            82323 |
#+TBLFM: @2$2..@>$2=remote(xmi-load, @@#$4)
#+TBLFM: @2$3..@>$3=remote(xmi-view-load, @@#$4)
#+TBLFM: @2$4..@>$4=remote(neoemf-load-direct-write,@@#$4)
#+TBLFM: @2$5..@>$5=remote(neoemf-load-long-list,@@#$4)
#+TBLFM: @2$6..@>$6=remote(neoemf-view-load-long-list,@@#$4)

#+begin_src gnuplot :var data=agg-load :file bench-all-load-view.png
set title 'Load view (time)'
set key left font ",9"

set xlabel 'model size (10^n)'
set logscale x
set ylabel 'time (ms)'
set logscale y

plot data u (10**$1):2 w lp title 'XMI', \
     data u (10**$1):3 w lp title 'XMI View', \
     data u (10**$1):4 w lp title 'NeoEMF', \
     data u (10**$1):5 w lp title 'NeoEMF (LL)', \
     data u (10**$1):6 w lp title 'NeoEMF View (LL)'
#+end_src

#+RESULTS:
[[file:bench-all-load-view.png]]

* Running a simple OCL query
OCL query: ~Log.allInstances()->size()~

Legend:
- Size :: ibidem
- Load :: time to load the resource
- Eval :: time to ~ocl.evaluate(query)~
- Full :: time for all of the above, plus creating the OCL query from a parsed
          expression

** Using EMF trace
*** No weaving model
**** Default extent map
#+name: ocl-xmi
| size | load | eval | full |
|------+------+------+------|
|    1 |   11 |   11 |  300 |
|    2 |    4 |    1 |    8 |
|    3 |   23 |    2 |   28 |
|    4 |  128 |   11 |  142 |
|    5 |  944 |  115 | 1067 |
|    6 | 3227 |  549 | 3778 |

**** Fast extent map
#+name: ocl-xmi-opt
| size | load | eval | full |
|------+------+------+------|
|    1 |   16 | 13   | 310  |
|    2 |    7 | 1    | 14   |
|    3 |   24 | 3    | 30   |
|    4 |  122 | 10   | 135  |
|    5 |  526 | 113  | 646  |
|    6 | 2104 | 1375 | 3481 |

*** XMI weaving model
**** Default extent map
#+name: ocl-xmi-full-view
| size | load | eval |  full |
|------+------+------+-------|
|    1 |  849 | 1083 |  1934 |
|    2 |  319 |  683 |  1004 |
|    3 |  336 |  477 |   814 |
|    4 |  314 |  433 |   749 |
|    5 |  975 |  872 |  1848 |
|    6 | 9141 | 5485 | 14627 |

**** Fast extent map
#+name: ocl-xmi-full-view-opt
| size |  load | eval |  full |
|------+-------+------+-------|
|    1 |  1138 |   49 |  1190 |
|    2 |   349 |   25 |   376 |
|    3 |   386 |   19 |   407 |
|    4 |   529 |   22 |   553 |
|    5 |  1315 |  576 |  1892 |
|    6 | 10049 |  752 | 10802 |

** Using SOM-NeoEMF trace
*** No weaving model
**** Default extent map
#+name: ocl-neoemf
| size | load |  eval |   full |
|------+------+-------+--------|
|    1 |  575 |   156 |   1847 |
|    2 |   41 |   144 |    343 |
|    3 |   40 |   477 |    752 |
|    4 |   28 |  1625 |   2118 |
|    5 |   27 |  6485 |   9025 |
|    6 |   75 | 72481 | 114903 |

**** Fast extent map
#+name: ocl-neoemf-opt
| size | load |  eval |  full |
|------+------+-------+-------|
|    1 |  646 |    16 |  1464 |
|    2 |   48 |    40 |   170 |
|    3 |   39 |   198 |   328 |
|    4 |   26 |   373 |   522 |
|    5 |   35 |  1568 |  1867 |
|    6 |   41 | 16182 | 17584 |

*** View on trace model
**** Default extent map
#+name: ocl-neoemf-simple-view
| size | load |  eval |   full |
|------+------+-------+--------|
|    1 |   60 |     6 |    208 |
|    2 |   37 |    27 |    195 |
|    3 |   32 |   130 |    306 |
|    4 |  111 |  1150 |   1458 |
|    5 |  148 |  5603 |   6984 |
|    6 |  907 | 86565 | 136376 |

**** Fast extent map
#+name: ocl-neoemf-simple-view-opt
| size | load |  eval |  full |
|------+------+-------+-------|
|    1 |   46 |    20 |   148 |
|    2 |   51 |     6 |   132 |
|    3 |   32 |    22 |   129 |
|    4 |  111 |   177 |   390 |
|    5 |  156 |  1240 |  1506 |
|    6 | 1094 | 15981 | 17331 |

*** View on four models
**** Default extent map
#+name: ocl-neoemf-full-view
| size | load |  eval |   full |
|------+------+-------+--------|
|    1 | 2651 |  5655 |   8550 |
|    2 |  920 |  2694 |   3878 |
|    3 |  858 |  2087 |   3224 |
|    4 |  783 |  2707 |   3816 |
|    5 |  906 |  7777 |  10025 |
|    6 | 3118 | 85030 | 128345 |

**** Fast extent map
#+name: ocl-neoemf-full-view-opt
| size | load |  eval |  full |
|------+------+-------+-------|
|    1 | 2226 |  4722 |  7137 |
|    2 | 4106 |  3000 |  7297 |
|    3 |  761 |  1744 |  2681 |
|    4 |  812 |  1905 |  2941 |
|    5 |  824 |  2309 |  3382 |
|    6 | 2681 | 14544 | 17699 |

** Aggregate results and graphs
*** Default extents map
#+name: agg-ocl
| size | XMI | XMI View | NeoEMF | NeoEMF View (Simple) | NeoEMF View (Full) |
|------+-----+----------+--------+----------------------+--------------------|
|    1 |  11 |     1083 |    156 |                    6 |               5655 |
|    2 |   1 |      683 |    144 |                   27 |               2694 |
|    3 |   2 |      477 |    477 |                  130 |               2087 |
|    4 |  11 |      433 |   1625 |                 1150 |               2707 |
|    5 | 115 |      872 |   6485 |                 5603 |               7777 |
|    6 | 549 |     5485 |  72481 |                86565 |              85030 |
#+TBLFM: @2$2..@>$2=remote(ocl-xmi, @@#$3)
#+TBLFM: @2$3..@>$3=remote(ocl-xmi-full-view, @@#$3)
#+TBLFM: @2$4..@>$4=remote(ocl-neoemf,@@#$3)
#+TBLFM: @2$5..@>$5=remote(ocl-neoemf-simple-view,@@#$3)
#+TBLFM: @2$6..@>$6=remote(ocl-neoemf-full-view,@@#$3)

#+begin_src gnuplot :var data=agg-ocl :file bench-all-ocl-all-instances.png
set title 'OCL query (Log.allInstances()->size())'
set key left font ",9"

set xlabel 'model size (10^n)'
set logscale x
set ylabel 'time (ms)'
set logscale y

plot data u (10**$1):2 w lp title 'XMI', \
     data u (10**$1):3 w lp title 'XMI View', \
     data u (10**$1):4 w lp title 'NeoEMF', \
     data u (10**$1):5 w lp title 'NeoEMF View (Simple)', \
     data u (10**$1):6 w lp title 'NeoEMF View (Full)'
#+end_src

#+RESULTS:
[[file:bench-all-ocl-all-instances.png]]

*** Fast extents map
#+name: agg-ocl-opt
| size |  XMI | XMI View | NeoEMF | NeoEMF View (Simple) | NeoEMF View (Full) |
|------+------+----------+--------+----------------------+--------------------|
|    1 |   13 |       49 |     16 |                   20 |               4722 |
|    2 |    1 |       25 |     40 |                    6 |               3000 |
|    3 |    3 |       19 |    198 |                   22 |               1744 |
|    4 |   10 |       22 |    373 |                  177 |               1905 |
|    5 |  113 |      576 |   1568 |                 1240 |               2309 |
|    6 | 1375 |      752 |  16182 |                15981 |              14544 |
#+TBLFM: @2$2..@>$2=remote(ocl-xmi-opt, @@#$3)
#+TBLFM: @2$3..@>$3=remote(ocl-xmi-full-view-opt, @@#$3)
#+TBLFM: @2$4..@>$4=remote(ocl-neoemf-opt,@@#$3)
#+TBLFM: @2$5..@>$5=remote(ocl-neoemf-simple-view-opt,@@#$3)
#+TBLFM: @2$6..@>$6=remote(ocl-neoemf-full-view-opt,@@#$3)

#+begin_src gnuplot :var data=agg-ocl-opt :file bench-all-ocl-all-instances-opt.png
set title 'OCL query (Log.allInstances()->size()) (Fast extents map)'
set key left font ",9"

set xlabel 'model size (10^n)'
set logscale x
set ylabel 'time (ms)'
set logscale y

plot data u (10**$1):2 w lp title 'XMI', \
     data u (10**$1):3 w lp title 'XMI View', \
     data u (10**$1):4 w lp title 'NeoEMF', \
     data u (10**$1):5 w lp title 'NeoEMF View (Simple)', \
     data u (10**$1):6 w lp title 'NeoEMF View (Full)'
#+end_src

#+RESULTS:
[[file:bench-all-ocl-all-instances-opt.png]]

** Comparing extents maps on views
| size |  XMI | XMI (Opt.) | NeoEMF | NeoEMF (Opt.) |
|------+------+------------+--------+---------------|
|    1 | 1083 |         49 |   5655 |          4722 |
|    2 |  683 |         25 |   2694 |          3000 |
|    3 |  477 |         19 |   2087 |          1744 |
|    4 |  433 |         22 |   2707 |          1905 |
|    5 |  872 |        576 |   7777 |          2309 |
|    6 | 5485 |        752 |  85030 |         14544 |
#+TBLFM: @2$2..@>$2=remote(ocl-xmi-full-view, @@#$3)
#+TBLFM: @2$3..@>$3=remote(ocl-xmi-full-view-opt, @@#$3)
#+TBLFM: @2$4..@>$4=remote(ocl-neoemf-full-view,@@#$3)
#+TBLFM: @2$5..@>$5=remote(ocl-neoemf-full-view-opt,@@#$3)

* Running other OCL queries
Query ~traceToReqs~:
#+BEGIN_SRC
trace::Log.allInstances()
  ->any(l | l.message.startsWith('CaptchaValidateFilter'))
  .javaClass._'package'.component.requirements->size()
#+END_SRC

Query ~reqToTraces~:
#+BEGIN_SRC
reqif10::SpecObject.allInstances()
  ->any(r | r.values->selectByType(reqif10::AttributeValueString)->exists(v | v.theValue.startsWith('Controller')))
  .components->collect(c | c.javaPackages)->collect(p | p.ownedElements)
  ->selectByType(java::ClassDeclaration)
  ->collect(c | c.traces)
  ->size()
#+END_SRC

These queries can only be applied to views, so there are only two benches.

** XMI view
*** No extents map
**** Query traceToReq
#+name: ocl-xmi-query2
| size |  load | eval |  full |
|------+-------+------+-------|
|    1 |  1284 | 1093 |  2744 |
|    2 |   321 |  711 |  1039 |
|    3 |   259 |  527 |   791 |
|    4 |   635 |  570 |  1210 |
|    5 |  1221 | 1050 |  2278 |
|    6 | 11169 | 6294 | 17469 |

**** Query reqToTraces
#+name: ocl-xmi-query3
| size |  load |  eval |  full |
|------+-------+-------+-------|
|    1 |   650 |  1133 |  1962 |
|    2 |   205 |   664 |   879 |
|    3 |   168 |   688 |   865 |
|    4 |   283 |   691 |   983 |
|    5 |   858 |  1757 |  2621 |
|    6 | 12221 | 12722 | 24951 |

*** Fast extents map
**** Query traceToReq
#+name: ocl-xmi-query2-opt
| size |  load | eval |  full |
|------+-------+------+-------|
|    1 |   935 |  116 |  1309 |
|    2 |   353 |   31 |   390 |
|    3 |   485 |   33 |   525 |
|    4 |   467 |   68 |   551 |
|    5 |  1534 |  241 |  1780 |
|    6 | 10804 | 4008 | 14817 |

**** Query reqToTraces
#+name: ocl-xmi-query3-opt
| size |  load | eval |  full |
|------+-------+------+-------|
|    1 |   867 |  186 |  1246 |
|    2 |   454 |   26 |   494 |
|    3 |   300 |   46 |   362 |
|    4 |   362 |  248 |   625 |
|    5 |  1351 |  857 |  2216 |
|    6 | 11048 | 7647 | 18700 |

** NeoEMF view
*** No extents map
**** Query traceToReq
#+name: ocl-neoemf-query2
| size |  load |   eval |   full |
|------+-------+--------+--------|
|    1 |  7083 |   5075 |  13303 |
|    2 |   814 |   3478 |   4596 |
|    3 |   943 |   3256 |   4536 |
|    4 |  1037 |   5336 |   7095 |
|    5 |  2937 |  16604 |  21810 |
|    6 | 24342 | 178444 | 246010 |

**** Query reqToTraces
#+name: ocl-neoemf-query3
| size | load |   eval |   full |
|------+------+--------+--------|
|    1 | 5643 |   4473 |  10421 |
|    2 |  866 |   2575 |   3732 |
|    3 |  824 |   2148 |   3294 |
|    4 |  777 |   5138 |   6384 |
|    5 |  743 |  18518 |  21478 |
|    6 | 2729 | 251451 | 289261 |

*** Fast extends map
**** Query traceToReq
#+name: ocl-neoemf-query2-opt
| size | load |   eval |   full |
|------+------+--------+--------|
|    1 | 4504 |   4043 |   8753 |
|    2 |  798 |   2563 |   3547 |
|    3 |  851 |   2087 |   3148 |
|    4 |  853 |   3173 |   4236 |
|    5 | 1047 |   9626 |  11005 |
|    6 | 2971 | 114733 | 118656 |

**** Query reqToTraces
#+name: ocl-neoemf-query3-opt
| size | load |   eval |   full |
|------+------+--------+--------|
|    1 | 3680 |   3860 |   7775 |
|    2 |  860 |   2270 |   3331 |
|    3 |  774 |   1869 |   2829 |
|    4 |  752 |   3147 |   4142 |
|    5 | 1003 |  12843 |  14100 |
|    6 | 2749 | 154621 | 158226 |

** Aggregate results and graphs

- Opt. :: using the fast extents map for OCL

#+name: agg-ocl-query2
| size |  XMI | XMI (Opt.) | NeoEMF | NeoEMF (Opt.) |
|------+------+------------+--------+---------------|
|    1 | 1093 |        116 |   5075 |          4043 |
|    2 |  711 |         31 |   3478 |          2563 |
|    3 |  527 |         33 |   3256 |          2087 |
|    4 |  570 |         68 |   5336 |          3173 |
|    5 | 1050 |        241 |  16604 |          9626 |
|    6 | 6294 |       4008 | 178444 |        114733 |
#+TBLFM: @2$2..@>$2=remote(ocl-xmi-query2, @@#$3)
#+TBLFM: @2$3..@>$3=remote(ocl-xmi-query2-opt, @@#$3)
#+TBLFM: @2$4..@>$4=remote(ocl-neoemf-query2,@@#$3)
#+TBLFM: @2$5..@>$5=remote(ocl-neoemf-query2-opt,@@#$3)

#+name: agg-ocl-query3
| size |   XMI | XMI (Opt.) | NeoEMF | NeoEMF (Opt.) |
|------+-------+------------+--------+---------------|
|    1 |  1133 |        186 |   4473 |          3860 |
|    2 |   664 |         26 |   2575 |          2270 |
|    3 |   688 |         46 |   2148 |          1869 |
|    4 |   691 |        248 |   5138 |          3147 |
|    5 |  1757 |        857 |  18518 |         12843 |
|    6 | 12722 |       7647 | 251451 |        154621 |
#+TBLFM: @2$2..@>$2=remote(ocl-xmi-query3, @@#$3)
#+TBLFM: @2$3..@>$3=remote(ocl-xmi-query3-opt, @@#$3)
#+TBLFM: @2$4..@>$4=remote(ocl-neoemf-query3,@@#$3)
#+TBLFM: @2$5..@>$5=remote(ocl-neoemf-query3-opt,@@#$3)
